
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>More advanced topics &#8212; Psycopg 2.9.5 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/better.css" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19287248-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-19287248-2');
    </script>
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="psycopg2.extensions – Extensions to the DB API" href="extensions.html" />
    <link rel="prev" title="The cursor class" href="cursor.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
      <link rel="stylesheet" href="_static/psycopg.css" type="text/css" />
  </head><body>
    <header id="pageheader"><h1><a href="index.html ">
        Psycopg 2.9.5 documentation
    </a></h1></header>
  <div class="related top">
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="cursor.html" title="Previous document">The <code class="docutils literal notranslate"><span class="pre">cursor</span></code> class</a>
        </li>
        <li>
          <a href="extensions.html" title="Next document"><code class="xref py py-obj docutils literal notranslate"><span class="pre">psycopg2.extensions</span></code> – Extensions to the DB API</a>
          &rarr;
        </li>
    </ul>
  </nav>
  <nav id="breadcrumbs">
    <ul>
      <li><a href="index.html">Home</a></li> 
    </ul>
  </nav>
  </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="more-advanced-topics">
<h1>More advanced topics<a class="headerlink" href="#more-advanced-topics" title="Permalink to this headline">¶</a></h1>
<section id="connection-and-cursor-factories">
<span id="subclassing-cursor"></span><span id="subclassing-connection"></span><span id="index-0"></span><h2>Connection and cursor factories<a class="headerlink" href="#connection-and-cursor-factories" title="Permalink to this headline">¶</a></h2>
<p>Psycopg exposes two new-style classes that can be sub-classed and expanded to
adapt them to the needs of the programmer: <a class="reference internal" href="extensions.html#psycopg2.extensions.cursor" title="psycopg2.extensions.cursor"><code class="xref py py-obj docutils literal notranslate"><span class="pre">psycopg2.extensions.cursor</span></code></a>
and <a class="reference internal" href="extensions.html#psycopg2.extensions.connection" title="psycopg2.extensions.connection"><code class="xref py py-obj docutils literal notranslate"><span class="pre">psycopg2.extensions.connection</span></code></a>.  The <a class="reference internal" href="connection.html#connection" title="connection"><code class="xref py py-obj docutils literal notranslate"><span class="pre">connection</span></code></a> class is
usually sub-classed only to provide an easy way to create customized cursors
but other uses are possible. <a class="reference internal" href="cursor.html#cursor" title="cursor"><code class="xref py py-obj docutils literal notranslate"><span class="pre">cursor</span></code></a> is much more interesting, because
it is the class where query building, execution and result type-casting into
Python variables happens.</p>
<p>The <a class="reference internal" href="extras.html#module-psycopg2.extras" title="psycopg2.extras"><code class="xref py py-obj docutils literal notranslate"><span class="pre">extras</span></code></a> module contains several examples of <a class="reference internal" href="extras.html#cursor-subclasses"><span class="std std-ref">connection
and cursor subclasses</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you only need a customized cursor class, since Psycopg 2.5 you can use
the <a class="reference internal" href="connection.html#connection.cursor_factory" title="connection.cursor_factory"><code class="xref py py-obj docutils literal notranslate"><span class="pre">cursor_factory</span></code></a> parameter of a regular connection instead
of creating a new <code class="xref py py-obj docutils literal notranslate"><span class="pre">connection</span></code> subclass.</p>
</div>
<p id="index-1">An example of cursor subclass performing logging is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">import</span> <span class="nn">psycopg2.extensions</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="k">class</span> <span class="nc">LoggingCursor</span><span class="p">(</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">cursor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sql_debug&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mogrify</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
            <span class="k">raise</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DSN</span><span class="p">)</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">cursor_factory</span><span class="o">=</span><span class="n">LoggingCursor</span><span class="p">)</span>
<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO mytable VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">);&quot;</span><span class="p">,</span>
             <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="adapting-new-python-types-to-sql-syntax">
<span id="adapting-new-types"></span><span id="index-2"></span><h2>Adapting new Python types to SQL syntax<a class="headerlink" href="#adapting-new-python-types-to-sql-syntax" title="Permalink to this headline">¶</a></h2>
<p>Any Python class or type can be adapted to an SQL string.  Adaptation mechanism
is similar to the Object Adaptation proposed in the <span class="target" id="index-3"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0246"><strong>PEP 246</strong></a> and is exposed
by the <a class="reference internal" href="extensions.html#psycopg2.extensions.adapt" title="psycopg2.extensions.adapt"><code class="xref py py-obj docutils literal notranslate"><span class="pre">psycopg2.extensions.adapt()</span></code></a> function.</p>
<p>The <a class="reference internal" href="cursor.html#cursor.execute" title="cursor.execute"><code class="xref py py-obj docutils literal notranslate"><span class="pre">execute()</span></code></a> method adapts its arguments to the
<a class="reference internal" href="extensions.html#psycopg2.extensions.ISQLQuote" title="psycopg2.extensions.ISQLQuote"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ISQLQuote</span></code></a> protocol.  Objects that conform to this
protocol expose a <code class="xref py py-obj docutils literal notranslate"><span class="pre">getquoted()</span></code> method returning the SQL representation
of the object as a string (the method must return <code class="xref py py-obj docutils literal notranslate"><span class="pre">bytes</span></code> in Python 3).
Optionally the conform object may expose a
<a class="reference internal" href="extensions.html#psycopg2.extensions.ISQLQuote.prepare" title="psycopg2.extensions.ISQLQuote.prepare"><code class="xref py py-obj docutils literal notranslate"><span class="pre">prepare()</span></code></a> method.</p>
<p>There are two basic ways to have a Python object adapted to SQL:</p>
<ul class="simple">
<li><p>the object itself is conform, or knows how to make itself conform. Such
object must expose a <code class="xref py py-obj docutils literal notranslate"><span class="pre">__conform__()</span></code> method that will be called with the
protocol object as argument. The object can check that the protocol is
<code class="xref py py-obj docutils literal notranslate"><span class="pre">ISQLQuote</span></code>, in which case it can return <code class="xref py py-obj docutils literal notranslate"><span class="pre">self</span></code> (if the object also
implements <code class="xref py py-obj docutils literal notranslate"><span class="pre">getquoted()</span></code>) or a suitable wrapper object. This option is
viable if you are the author of the object and if the object is specifically
designed for the database (i.e. having Psycopg as a dependency and polluting
its interface with the required methods doesn’t bother you). For a simple
example you can take a look at the source code for the
<a class="reference internal" href="extras.html#psycopg2.extras.Inet" title="psycopg2.extras.Inet"><code class="xref py py-obj docutils literal notranslate"><span class="pre">psycopg2.extras.Inet</span></code></a> object.</p></li>
<li><p>If implementing the <code class="xref py py-obj docutils literal notranslate"><span class="pre">ISQLQuote</span></code> interface directly in the object is not an
option (maybe because the object to adapt comes from a third party library),
you can use an <em>adaptation function</em>, taking the object to be adapted as
argument and returning a conforming object.  The adapter must be
registered via the <a class="reference internal" href="extensions.html#psycopg2.extensions.register_adapter" title="psycopg2.extensions.register_adapter"><code class="xref py py-obj docutils literal notranslate"><span class="pre">register_adapter()</span></code></a> function.  A
simple example wrapper is <code class="xref py py-obj docutils literal notranslate"><span class="pre">psycopg2.extras.UUID_adapter</span></code> used by the
<a class="reference internal" href="extras.html#psycopg2.extras.register_uuid" title="psycopg2.extras.register_uuid"><code class="xref py py-obj docutils literal notranslate"><span class="pre">register_uuid()</span></code></a> function.</p></li>
</ul>
<p>A convenient object to write adapters is the <a class="reference internal" href="extensions.html#psycopg2.extensions.AsIs" title="psycopg2.extensions.AsIs"><code class="xref py py-obj docutils literal notranslate"><span class="pre">AsIs</span></code></a>
wrapper, whose <code class="xref py py-obj docutils literal notranslate"><span class="pre">getquoted()</span></code> result is simply the <code class="xref py py-obj docutils literal notranslate"><span class="pre">str()</span></code>ing conversion of
the wrapped object.</p>
<p id="index-4">Example: mapping of a <code class="xref py py-obj docutils literal notranslate"><span class="pre">Point</span></code> class into the <a class="reference external" href="https://www.postgresql.org/docs/current/static/datatype-geometric.html#DATATYPE-GEOMETRIC"><code class="sql docutils literal notranslate"><span class="pre">point</span></code></a> PostgreSQL
geometric type:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">psycopg2.extensions</span> <span class="kn">import</span> <span class="n">adapt</span><span class="p">,</span> <span class="n">register_adapter</span><span class="p">,</span> <span class="n">AsIs</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="gp">... </span>   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>       <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
<span class="gp">... </span>       <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">adapt_point</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">x</span> <span class="o">=</span> <span class="n">adapt</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">getquoted</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">y</span> <span class="o">=</span> <span class="n">adapt</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">getquoted</span><span class="p">()</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">AsIs</span><span class="p">(</span><span class="s2">&quot;&#39;(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">register_adapter</span><span class="p">(</span><span class="n">Point</span><span class="p">,</span> <span class="n">adapt_point</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO atable (apoint) VALUES (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
<span class="gp">... </span>            <span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="mf">1.23</span><span class="p">,</span> <span class="mf">4.56</span><span class="p">),))</span>
</pre></div>
</div>
<p>The above function call results in the SQL command:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">atable</span> <span class="p">(</span><span class="n">apoint</span><span class="p">)</span> <span class="n">VALUES</span> <span class="p">(</span><span class="s1">&#39;(1.23, 4.56)&#39;</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="type-casting-of-sql-types-into-python-objects">
<span id="type-casting-from-sql-to-python"></span><span id="index-5"></span><h2>Type casting of SQL types into Python objects<a class="headerlink" href="#type-casting-of-sql-types-into-python-objects" title="Permalink to this headline">¶</a></h2>
<p>PostgreSQL objects read from the database can be adapted to Python objects
through an user-defined adapting function.  An adapter function takes two
arguments: the object string representation as returned by PostgreSQL and the
cursor currently being read, and should return a new Python object.  For
example, the following function parses the PostgreSQL <code class="sql docutils literal notranslate"><span class="pre">point</span></code>
representation into the previously defined <code class="xref py py-obj docutils literal notranslate"><span class="pre">Point</span></code> class:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">cast_point</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cur</span><span class="p">):</span>
<span class="gp">... </span>   <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="gp">... </span>       <span class="k">return</span> <span class="kc">None</span>
<span class="gp">...</span>
<span class="gp">... </span>   <span class="c1"># Convert from (f1, f2) syntax using a regular expression.</span>
<span class="gp">... </span>   <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]+),([^)]+)\)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="gp">... </span>   <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
<span class="gp">... </span>       <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
<span class="gp">... </span>   <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>       <span class="k">raise</span> <span class="n">InterfaceError</span><span class="p">(</span><span class="s2">&quot;bad point representation: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>In order to create a mapping from a PostgreSQL type (either standard or
user-defined), its OID must be known. It can be retrieved either by the second
column of the <a class="reference internal" href="cursor.html#cursor.description" title="cursor.description"><code class="xref py py-obj docutils literal notranslate"><span class="pre">cursor.description</span></code></a>:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT NULL::point&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">point_oid</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">point_oid</span>
<span class="go">600</span>
</pre></div>
</div>
<p>or by querying the system catalog for the type name and namespace (the
namespace for system objects is <code class="sql docutils literal notranslate"><span class="pre">pg_catalog</span></code>):</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s2">   SELECT pg_type.oid</span>
<span class="gp">... </span><span class="s2">     FROM pg_type JOIN pg_namespace</span>
<span class="gp">... </span><span class="s2">            ON typnamespace = pg_namespace.oid</span>
<span class="gp">... </span><span class="s2">    WHERE typname = </span><span class="si">%(typename)s</span><span class="s2"></span>
<span class="gp">... </span><span class="s2">      AND nspname = </span><span class="si">%(namespace)s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
<span class="gp">... </span>   <span class="p">{</span><span class="s1">&#39;typename&#39;</span><span class="p">:</span> <span class="s1">&#39;point&#39;</span><span class="p">,</span> <span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="s1">&#39;pg_catalog&#39;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">point_oid</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">point_oid</span>
<span class="go">600</span>
</pre></div>
</div>
<p>After you know the object OID, you can create and register the new type:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">POINT</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">new_type</span><span class="p">((</span><span class="n">point_oid</span><span class="p">,),</span> <span class="s2">&quot;POINT&quot;</span><span class="p">,</span> <span class="n">cast_point</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">register_type</span><span class="p">(</span><span class="n">POINT</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="extensions.html#psycopg2.extensions.new_type" title="psycopg2.extensions.new_type"><code class="xref py py-obj docutils literal notranslate"><span class="pre">new_type()</span></code></a> function binds the object OIDs
(more than one can be specified) to the adapter function.
<a class="reference internal" href="extensions.html#psycopg2.extensions.register_type" title="psycopg2.extensions.register_type"><code class="xref py py-obj docutils literal notranslate"><span class="pre">register_type()</span></code></a> completes the spell.  Conversion
is automatically performed when a column whose type is a registered OID is
read:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT &#39;(10.2,20.3)&#39;::point&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">point</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="nb">type</span><span class="p">(</span><span class="n">point</span><span class="p">),</span> <span class="n">point</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">point</span><span class="o">.</span><span class="n">y</span>
<span class="go">&lt;class &#39;Point&#39;&gt; 10.2 20.3</span>
</pre></div>
</div>
<p>A typecaster created by <code class="xref py py-obj docutils literal notranslate"><span class="pre">new_type()</span></code> can be also used with
<a class="reference internal" href="extensions.html#psycopg2.extensions.new_array_type" title="psycopg2.extensions.new_array_type"><code class="xref py py-obj docutils literal notranslate"><span class="pre">new_array_type()</span></code></a> to create a typecaster converting a
PostgreSQL array into a Python list.</p>
</section>
<section id="asynchronous-notifications">
<span id="async-notify"></span><span id="index-6"></span><h2>Asynchronous notifications<a class="headerlink" href="#asynchronous-notifications" title="Permalink to this headline">¶</a></h2>
<p>Psycopg allows asynchronous interaction with other database sessions using the
facilities offered by PostgreSQL commands <a class="reference external" href="https://www.postgresql.org/docs/current/static/sql-listen.html"><code class="sql docutils literal notranslate"><span class="pre">LISTEN</span></code></a> and <a class="reference external" href="https://www.postgresql.org/docs/current/static/sql-notify.html"><code class="sql docutils literal notranslate"><span class="pre">NOTIFY</span></code></a>. Please
refer to the PostgreSQL documentation for examples about how to use this form of
communication.</p>
<p>Notifications are instances of the <a class="reference internal" href="extensions.html#psycopg2.extensions.Notify" title="psycopg2.extensions.Notify"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Notify</span></code></a> object made
available upon reception in the <a class="reference internal" href="connection.html#connection.notifies" title="connection.notifies"><code class="xref py py-obj docutils literal notranslate"><span class="pre">connection.notifies</span></code></a> list. Notifications can
be sent from Python code simply executing a <code class="sql docutils literal notranslate"><span class="pre">NOTIFY</span></code> command in an
<a class="reference internal" href="cursor.html#cursor.execute" title="cursor.execute"><code class="xref py py-obj docutils literal notranslate"><span class="pre">execute()</span></code></a> call.</p>
<p>Because of the way sessions interact with notifications (see <a class="reference external" href="https://www.postgresql.org/docs/current/static/sql-notify.html"><code class="sql docutils literal notranslate"><span class="pre">NOTIFY</span></code></a>
documentation), you should keep the connection in <a class="reference internal" href="connection.html#connection.autocommit" title="connection.autocommit"><code class="xref py py-obj docutils literal notranslate"><span class="pre">autocommit</span></code></a>
mode if you wish to receive or send notifications in a timely manner.</p>
<p>Notifications are received after every query execution. If the user is
interested in receiving notifications but not in performing any query, the
<a class="reference internal" href="connection.html#connection.poll" title="connection.poll"><code class="xref py py-obj docutils literal notranslate"><span class="pre">poll()</span></code></a> method can be used to check for new messages without
wasting resources.</p>
<p>A simple application could poll the connection from time to time to check if
something new has arrived. A better strategy is to use some I/O completion
function such as <a class="reference external" href="https://docs.python.org/3/library/select.html#select.select" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> to sleep until awakened by the kernel when there is
some data to read on the connection, thereby using no CPU unless there is
something to read:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">import</span> <span class="nn">psycopg2.extensions</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DSN</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">ISOLATION_LEVEL_AUTOCOMMIT</span><span class="p">)</span>

<span class="n">curs</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">curs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;LISTEN test;&quot;</span><span class="p">)</span>

<span class="nb">print</span> <span class="s2">&quot;Waiting for notifications on channel &#39;test&#39;&quot;</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">conn</span><span class="p">],[],[],</span><span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="p">([],[],[]):</span>
        <span class="nb">print</span> <span class="s2">&quot;Timeout&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">conn</span><span class="o">.</span><span class="n">notifies</span><span class="p">:</span>
            <span class="n">notify</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">notifies</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">print</span> <span class="s2">&quot;Got NOTIFY:&quot;</span><span class="p">,</span> <span class="n">notify</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">notify</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">notify</span><span class="o">.</span><span class="n">payload</span>
</pre></div>
</div>
<p>Running the script and executing a command such as <code class="sql docutils literal notranslate"><span class="pre">NOTIFY</span> <span class="pre">test,</span> <span class="pre">'hello'</span></code>
in a separate <strong class="program">psql</strong> shell, the output may look similar to:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Waiting for notifications on channel &#39;test&#39;
Timeout
Timeout
Got NOTIFY: 6535 test hello
Timeout
...
</pre></div>
</div>
<p>Note that the payload is only available from PostgreSQL 9.0: notifications
received from a previous version server will have the
<a class="reference internal" href="extensions.html#psycopg2.extensions.Notify.payload" title="psycopg2.extensions.Notify.payload"><code class="xref py py-obj docutils literal notranslate"><span class="pre">payload</span></code></a> attribute set to the empty string.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.3: </span>Added <a class="reference internal" href="extensions.html#psycopg2.extensions.Notify" title="psycopg2.extensions.Notify"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Notify</span></code></a> object and handling notification
payload.</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 2.7: </span>The <a class="reference internal" href="connection.html#connection.notifies" title="connection.notifies"><code class="xref py py-obj docutils literal notranslate"><span class="pre">notifies</span></code></a> attribute is writable: it is possible to
replace it with any object exposing an <code class="xref py py-obj docutils literal notranslate"><span class="pre">append()</span></code> method. An useful
example would be to use a <a class="reference external" href="https://docs.python.org/3/library/collections.html#collections.deque" title="(in Python v3.11)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">deque</span></code></a> object.</p>
</div>
</section>
<section id="asynchronous-support">
<span id="async-support"></span><span id="index-7"></span><h2>Asynchronous support<a class="headerlink" href="#asynchronous-support" title="Permalink to this headline">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.2.</span></p>
</div>
<p>Psycopg can issue asynchronous queries to a PostgreSQL database. An asynchronous
communication style is established passing the parameter <em>async</em>=1 to the
<a class="reference internal" href="module.html#psycopg2.connect" title="psycopg2.connect"><code class="xref py py-obj docutils literal notranslate"><span class="pre">connect()</span></code></a> function: the returned connection will work in
<em>asynchronous mode</em>.</p>
<p>In asynchronous mode, a Psycopg connection will rely on the caller to poll the
socket file descriptor, checking if it is ready to accept data or if a query
result has been transferred and is ready to be read on the client. The caller
can use the method <a class="reference internal" href="connection.html#connection.fileno" title="connection.fileno"><code class="xref py py-obj docutils literal notranslate"><span class="pre">fileno()</span></code></a> to get the connection file
descriptor and <a class="reference internal" href="connection.html#connection.poll" title="connection.poll"><code class="xref py py-obj docutils literal notranslate"><span class="pre">poll()</span></code></a> to make communication proceed according to
the current connection state.</p>
<p>The following is an example loop using methods <code class="xref py py-obj docutils literal notranslate"><span class="pre">fileno()</span></code> and <code class="xref py py-obj docutils literal notranslate"><span class="pre">poll()</span></code>
together with the Python <a class="reference external" href="https://docs.python.org/3/library/select.html#select.select" title="(in Python v3.11)"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> function in order to carry on
asynchronous operations with Psycopg:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">POLL_OK</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">POLL_WRITE</span><span class="p">:</span>
            <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([],</span> <span class="p">[</span><span class="n">conn</span><span class="o">.</span><span class="n">fileno</span><span class="p">()],</span> <span class="p">[])</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">POLL_READ</span><span class="p">:</span>
            <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">conn</span><span class="o">.</span><span class="n">fileno</span><span class="p">()],</span> <span class="p">[],</span> <span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">(</span><span class="s2">&quot;poll() returned </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">state</span><span class="p">)</span>
</pre></div>
</div>
<p>The above loop of course would block an entire application: in a real
asynchronous framework, <code class="xref py py-obj docutils literal notranslate"><span class="pre">select()</span></code> would be called on many file descriptors
waiting for any of them to be ready.  Nonetheless the function can be used to
connect to a PostgreSQL server only using nonblocking commands and the
connection obtained can be used to perform further nonblocking queries.  After
<code class="xref py py-obj docutils literal notranslate"><span class="pre">poll()</span></code> has returned <a class="reference internal" href="extensions.html#psycopg2.extensions.POLL_OK" title="psycopg2.extensions.POLL_OK"><code class="xref py py-obj docutils literal notranslate"><span class="pre">POLL_OK</span></code></a>, and thus <code class="xref py py-obj docutils literal notranslate"><span class="pre">wait()</span></code> has
returned, the connection can be safely used:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">aconn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="k">async</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">wait</span><span class="p">(</span><span class="n">aconn</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">acurs</span> <span class="o">=</span> <span class="n">aconn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</pre></div>
</div>
<p>Note that there are a few other requirements to be met in order to have a
completely non-blocking connection attempt: see the libpq documentation for
<a class="reference external" href="https://www.postgresql.org/docs/current/static/libpq-connect.html#LIBPQ-PQCONNECTSTARTPARAMS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">PQconnectStart()</span></code></a>.</p>
<p>The same loop should be also used to perform nonblocking queries: after
sending a query via <a class="reference internal" href="cursor.html#cursor.execute" title="cursor.execute"><code class="xref py py-obj docutils literal notranslate"><span class="pre">execute()</span></code></a> or <a class="reference internal" href="cursor.html#cursor.callproc" title="cursor.callproc"><code class="xref py py-obj docutils literal notranslate"><span class="pre">callproc()</span></code></a>, call
<code class="xref py py-obj docutils literal notranslate"><span class="pre">poll()</span></code> on the connection available from <a class="reference internal" href="cursor.html#cursor.connection" title="cursor.connection"><code class="xref py py-obj docutils literal notranslate"><span class="pre">cursor.connection</span></code></a> until it
returns <code class="xref py py-obj docutils literal notranslate"><span class="pre">POLL_OK</span></code>, at which point the query has been completely sent to the
server and, if it produced data, the results have been transferred to the
client and available using the regular cursor methods:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">acurs</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT pg_sleep(5); SELECT 42;&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">wait</span><span class="p">(</span><span class="n">acurs</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">acurs</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">42</span>
</pre></div>
</div>
<p>When an asynchronous query is being executed, <a class="reference internal" href="connection.html#connection.isexecuting" title="connection.isexecuting"><code class="xref py py-obj docutils literal notranslate"><span class="pre">connection.isexecuting()</span></code></a> returns
<code class="xref py py-obj docutils literal notranslate"><span class="pre">True</span></code>. Two cursors can’t execute concurrent queries on the same asynchronous
connection.</p>
<p>There are several limitations in using asynchronous connections: the
connection is always in <a class="reference internal" href="connection.html#connection.autocommit" title="connection.autocommit"><code class="xref py py-obj docutils literal notranslate"><span class="pre">autocommit</span></code></a> mode and it is not
possible to change it. So a
transaction is not implicitly started at the first query and is not possible
to use methods <a class="reference internal" href="connection.html#connection.commit" title="connection.commit"><code class="xref py py-obj docutils literal notranslate"><span class="pre">commit()</span></code></a> and <a class="reference internal" href="connection.html#connection.rollback" title="connection.rollback"><code class="xref py py-obj docutils literal notranslate"><span class="pre">rollback()</span></code></a>: you can
manually control transactions using <a class="reference internal" href="cursor.html#cursor.execute" title="cursor.execute"><code class="xref py py-obj docutils literal notranslate"><span class="pre">execute()</span></code></a> to send database
commands such as <code class="sql docutils literal notranslate"><span class="pre">BEGIN</span></code>, <code class="sql docutils literal notranslate"><span class="pre">COMMIT</span></code> and <code class="sql docutils literal notranslate"><span class="pre">ROLLBACK</span></code>. Similarly
<a class="reference internal" href="connection.html#connection.set_session" title="connection.set_session"><code class="xref py py-obj docutils literal notranslate"><span class="pre">set_session()</span></code></a> can’t be used but it is still possible to invoke the
<code class="sql docutils literal notranslate"><span class="pre">SET</span></code> command with the proper <code class="sql docutils literal notranslate"><span class="pre">default_transaction_...</span></code> parameter.</p>
<p>With asynchronous connections it is also not possible to use
<a class="reference internal" href="connection.html#connection.set_client_encoding" title="connection.set_client_encoding"><code class="xref py py-obj docutils literal notranslate"><span class="pre">set_client_encoding()</span></code></a>, <a class="reference internal" href="cursor.html#cursor.executemany" title="cursor.executemany"><code class="xref py py-obj docutils literal notranslate"><span class="pre">executemany()</span></code></a>, <a class="reference internal" href="usage.html#large-objects"><span class="std std-ref">large
objects</span></a>, <a class="reference internal" href="usage.html#server-side-cursors"><span class="std std-ref">named cursors</span></a>.</p>
<p><a class="reference internal" href="usage.html#copy"><span class="std std-ref">COPY commands</span></a> are not supported either in asynchronous mode, but
this will be probably implemented in a future release.</p>
</section>
<section id="support-for-coroutine-libraries">
<span id="green-support"></span><span id="index-8"></span><h2>Support for coroutine libraries<a class="headerlink" href="#support-for-coroutine-libraries" title="Permalink to this headline">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.2.</span></p>
</div>
<p>Psycopg can be used together with <a class="reference external" href="https://en.wikipedia.org/wiki/Coroutine">coroutine</a>-based libraries and participate
in cooperative multithreading.</p>
<p>Coroutine-based libraries (such as <a class="reference external" href="https://eventlet.net/">Eventlet</a> or <a class="reference external" href="http://www.gevent.org/">gevent</a>) can usually patch the
Python standard library in order to enable a coroutine switch in the presence of
blocking I/O: the process is usually referred as making the system <em>green</em>, in
reference to the <a class="reference external" href="https://en.wikipedia.org/wiki/Green_threads">green threads</a>.</p>
<p>Because Psycopg is a C extension module, it is not possible for coroutine
libraries to patch it: Psycopg instead enables cooperative multithreading by
allowing the registration of a <em>wait callback</em> using the
<a class="reference internal" href="extensions.html#psycopg2.extensions.set_wait_callback" title="psycopg2.extensions.set_wait_callback"><code class="xref py py-obj docutils literal notranslate"><span class="pre">psycopg2.extensions.set_wait_callback()</span></code></a> function. When a wait callback is
registered, Psycopg will use <a class="reference external" href="https://www.postgresql.org/docs/current/static/libpq-async.html">libpq non-blocking calls</a> instead of the regular
blocking ones, and will delegate to the callback the responsibility to wait
for the socket to become readable or writable.</p>
<p>Working this way, the caller does not have the complete freedom to schedule the
socket check whenever they want as with an <a class="reference internal" href="#async-support"><span class="std std-ref">asynchronous connection</span></a>, but has the advantage of maintaining a complete DB API 2.0
semantics: from the point of view of the end user, all Psycopg functions and
objects will work transparently in the coroutine environment (blocking the
calling green thread and giving other green threads the possibility to be
scheduled), allowing non modified code and third party libraries (such as
<a class="reference external" href="https://www.sqlalchemy.org/">SQLAlchemy</a>) to be used in coroutine-based programs.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Psycopg connections are not <em>green thread safe</em> and can’t be used
concurrently by different green threads. Trying to execute more than one
command at time using one cursor per thread will result in an error (or a
deadlock on versions before 2.4.2).</p>
<p>Therefore, programmers are advised to either avoid sharing connections
between coroutines or to use a library-friendly lock to synchronize shared
connections, e.g. for pooling.</p>
</div>
<p>Coroutine libraries authors should provide a callback implementation (and
possibly a method to register it) to make Psycopg as green as they want. An
example callback (using <code class="xref py py-obj docutils literal notranslate"><span class="pre">select()</span></code> to block) is provided as
<a class="reference internal" href="extras.html#psycopg2.extras.wait_select" title="psycopg2.extras.wait_select"><code class="xref py py-obj docutils literal notranslate"><span class="pre">psycopg2.extras.wait_select()</span></code></a>: it boils down to something similar to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">wait_select</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">extensions</span><span class="o">.</span><span class="n">POLL_OK</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">extensions</span><span class="o">.</span><span class="n">POLL_READ</span><span class="p">:</span>
            <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">conn</span><span class="o">.</span><span class="n">fileno</span><span class="p">()],</span> <span class="p">[],</span> <span class="p">[])</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">extensions</span><span class="o">.</span><span class="n">POLL_WRITE</span><span class="p">:</span>
            <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([],</span> <span class="p">[</span><span class="n">conn</span><span class="o">.</span><span class="n">fileno</span><span class="p">()],</span> <span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OperationalError</span><span class="p">(</span><span class="s2">&quot;bad state from poll: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">state</span><span class="p">)</span>
</pre></div>
</div>
<p>Providing callback functions for the single coroutine libraries is out of
psycopg2 scope, as the callback can be tied to the libraries’ implementation
details. You can check the <a class="reference external" href="https://github.com/psycopg/psycogreen/">psycogreen</a> project for further informations and
resources about the topic.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><a class="reference internal" href="usage.html#copy"><span class="std std-ref">COPY commands</span></a> are currently not supported when a wait callback
is registered, but they will be probably implemented in a future release.</p>
<p><a class="reference internal" href="usage.html#large-objects"><span class="std std-ref">Large objects</span></a> are not supported either: they are
not compatible with asynchronous connections.</p>
</div>
</section>
<section id="replication-protocol-support">
<span id="replication-support"></span><span id="index-9"></span><h2>Replication protocol support<a class="headerlink" href="#replication-protocol-support" title="Permalink to this headline">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified added">New in version 2.7.</span></p>
</div>
<p>Modern PostgreSQL servers (version 9.0 and above) support replication.  The
replication protocol is built on top of the client-server protocol and can be
operated using <code class="docutils literal notranslate"><span class="pre">libpq</span></code>, as such it can be also operated by <code class="docutils literal notranslate"><span class="pre">psycopg2</span></code>.
The replication protocol can be operated on both synchronous and
<a class="reference internal" href="#async-support"><span class="std std-ref">asynchronous</span></a> connections.</p>
<p>Server version 9.4 adds a new feature called <em>Logical Replication</em>.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<ul class="simple">
<li><p>PostgreSQL <a class="reference external" href="https://www.postgresql.org/docs/current/static/protocol-replication.html">Streaming Replication Protocol</a></p></li>
</ul>
</div>
<section id="logical-replication-quick-start">
<h3>Logical replication Quick-Start<a class="headerlink" href="#logical-replication-quick-start" title="Permalink to this headline">¶</a></h3>
<p>You must be using PostgreSQL server version 9.4 or above to run this quick
start.</p>
<p>Make sure that replication connections are permitted for user <code class="docutils literal notranslate"><span class="pre">postgres</span></code> in
<code class="docutils literal notranslate"><span class="pre">pg_hba.conf</span></code> and reload the server configuration.  You also need to set
<code class="docutils literal notranslate"><span class="pre">wal_level=logical</span></code> and <code class="docutils literal notranslate"><span class="pre">max_wal_senders</span></code>, <code class="docutils literal notranslate"><span class="pre">max_replication_slots</span></code> to
value greater than zero in <code class="docutils literal notranslate"><span class="pre">postgresql.conf</span></code> (these changes require a server
restart).  Create a database <code class="docutils literal notranslate"><span class="pre">psycopg2_test</span></code>.</p>
<p>Then run the following code to quickly try the replication support out.  This
is not production code – it’s only intended as a simple demo of logical
replication:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">import</span> <span class="nn">psycopg2.extras</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;dbname=psycopg2_test user=postgres&#39;</span><span class="p">,</span>
   <span class="n">connection_factory</span><span class="o">=</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extras</span><span class="o">.</span><span class="n">LogicalReplicationConnection</span><span class="p">)</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># test_decoding produces textual output</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">start_replication</span><span class="p">(</span><span class="n">slot_name</span><span class="o">=</span><span class="s1">&#39;pytest&#39;</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">create_replication_slot</span><span class="p">(</span><span class="s1">&#39;pytest&#39;</span><span class="p">,</span> <span class="n">output_plugin</span><span class="o">=</span><span class="s1">&#39;test_decoding&#39;</span><span class="p">)</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">start_replication</span><span class="p">(</span><span class="n">slot_name</span><span class="o">=</span><span class="s1">&#39;pytest&#39;</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DemoConsumer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">send_feedback</span><span class="p">(</span><span class="n">flush_lsn</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">data_start</span><span class="p">)</span>

<span class="n">democonsumer</span> <span class="o">=</span> <span class="n">DemoConsumer</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting streaming, press Control-C to end...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
   <span class="n">cur</span><span class="o">.</span><span class="n">consume_stream</span><span class="p">(</span><span class="n">democonsumer</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
   <span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
   <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The slot &#39;pytest&#39; still exists. Drop it with &quot;</span>
      <span class="s2">&quot;SELECT pg_drop_replication_slot(&#39;pytest&#39;); if no longer needed.&quot;</span><span class="p">,</span>
      <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Transaction logs will accumulate in pg_xlog &quot;</span>
      <span class="s2">&quot;until the slot is dropped.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</pre></div>
</div>
<p>You can now make changes to the <code class="docutils literal notranslate"><span class="pre">psycopg2_test</span></code> database using a normal
psycopg2 session, <code class="docutils literal notranslate"><span class="pre">psql</span></code>, etc. and see the logical decoding stream printed
by this demo client.</p>
<p>This will continue running until terminated with <code class="docutils literal notranslate"><span class="pre">Control-C</span></code>.</p>
<p>For the details see <a class="reference internal" href="extras.html#replication-objects"><span class="std std-ref">Replication support objects</span></a>.</p>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">More advanced topics</a><ul>
<li><a class="reference internal" href="#connection-and-cursor-factories">Connection and cursor factories</a></li>
<li><a class="reference internal" href="#adapting-new-python-types-to-sql-syntax">Adapting new Python types to SQL syntax</a></li>
<li><a class="reference internal" href="#type-casting-of-sql-types-into-python-objects">Type casting of SQL types into Python objects</a></li>
<li><a class="reference internal" href="#asynchronous-notifications">Asynchronous notifications</a></li>
<li><a class="reference internal" href="#asynchronous-support">Asynchronous support</a></li>
<li><a class="reference internal" href="#support-for-coroutine-libraries">Support for coroutine libraries</a></li>
<li><a class="reference internal" href="#replication-protocol-support">Replication protocol support</a><ul>
<li><a class="reference internal" href="#logical-replication-quick-start">Logical replication Quick-Start</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
<h3>Quick search</h3>
<form class="search" action="search.html" method="get">
  <input type="text" name="q"
   placeholder="type to search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="related bottom">
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="cursor.html" title="Previous document">The <code class="docutils literal notranslate"><span class="pre">cursor</span></code> class</a>
        </li>
        <li>
          <a href="extensions.html" title="Next document"><code class="xref py py-obj docutils literal notranslate"><span class="pre">psycopg2.extensions</span></code> – Extensions to the DB API</a>
          &rarr;
        </li>
    </ul>
  </nav>
  <nav id="breadcrumbs">
    <ul>
      <li><a href="index.html">Home</a></li> 
    </ul>
  </nav>
  </div>
  <footer id="pagefooter">&copy; 2001-2021, Federico Di Gregorio, Daniele Varrazzo, The Psycopg Team.

  </footer>

  
  </body>
</html>