<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Using COPY TO and COPY FROM" href="copy.html" /><link rel="prev" title="Adapting other PostgreSQL types" href="pgtypes.html" />

    <meta name="generator" content="sphinx-4.5.0, furo 2021.11.23"/>
        <title>Transactions management - psycopg 3.1.dev0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=7f0192ddeb2adecfbaa87ffbcf67d16358b30bc1" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=0af69da206d614734f649b27d4cdc2dd6c31f41d" />
    <link rel="stylesheet" type="text/css" href="../_static/psycopg.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --admonition-font-size: 1rem;
  
  }
  body[data-theme="dark"] {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
  @media (prefers-color-scheme: dark) {
    body:not([data-theme="light"]) {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }
</style></head>
  <body>
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" />
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<div class="announcement">
  <aside class="announcement-content">
     <a style="text-decoration: none; color: white;"
   href="https://github.com/sponsors/dvarrazzo/">
   <img height="24px" width="24px" src="/img/logo/psycopg-48.png"/>
    Sponsor psycopg3 on GitHub
</a>
 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">psycopg 3.1.dev0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../_static/psycopg.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../_static/psycopg.svg" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">psycopg 3.1.dev0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Getting started with Psycopg 3</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="usage.html">Basic module usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="params.html">Passing parameters to SQL queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="adapt.html">Adapting basic Python types</a></li>
<li class="toctree-l2"><a class="reference internal" href="pgtypes.html">Adapting other PostgreSQL types</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Transactions management</a></li>
<li class="toctree-l2"><a class="reference internal" href="copy.html">Using COPY TO and COPY FROM</a></li>
<li class="toctree-l2"><a class="reference internal" href="from_pg2.html">Differences from <code class="docutils literal notranslate"><span class="pre">psycopg2</span></code></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../advanced/index.html">More advanced topics</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../advanced/async.html">Asynchronous operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced/typing.html">Static Typing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced/rows.html">Row factories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced/pool.html">Connection pools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced/cursors.html">Cursor types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced/adapt.html">Data adaptation configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced/prepare.html">Prepared statements</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/index.html">Psycopg 3 API</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/module.html">The <code class="xref py py-obj docutils literal notranslate"><span class="pre">psycopg</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/connections.html">Connection classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/cursors.html">Cursor classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/sql.html"><code class="xref py py-obj docutils literal notranslate"><span class="pre">sql</span></code> – SQL string composition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/rows.html"><code class="xref py py-obj docutils literal notranslate"><span class="pre">rows</span></code> – row factory implementations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/errors.html"><code class="xref py py-obj docutils literal notranslate"><span class="pre">errors</span></code> – Package exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/pool.html"><code class="xref py py-obj docutils literal notranslate"><span class="pre">psycopg_pool</span></code> – Connection pool implementations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/conninfo.html"><code class="xref py py-obj docutils literal notranslate"><span class="pre">conninfo</span></code> – manipulate connection strings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/adapt.html"><code class="xref py py-obj docutils literal notranslate"><span class="pre">adapt</span></code> – Types adaptation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/types.html"><code class="xref py py-obj docutils literal notranslate"><span class="pre">types</span></code> – Types information and adapters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/abc.html"><code class="xref py py-obj docutils literal notranslate"><span class="pre">abc</span></code> – Psycopg abstract classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/pq.html"><code class="xref py py-obj docutils literal notranslate"><span class="pre">pq</span></code> – libpq wrapper module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/dns.html"><code class="xref py py-obj docutils literal notranslate"><span class="pre">_dns</span></code> – DNS resolution utilities</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../news.html"><code class="docutils literal notranslate"><span class="pre">psycopg</span></code> release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../news_pool.html"><code class="docutils literal notranslate"><span class="pre">psycopg_pool</span></code> release notes</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <span class="target" id="index-0"></span><span class="target" id="index-1"></span><section id="transactions-management">
<span id="transactions"></span><span id="index-2"></span><h1>Transactions management<a class="headerlink" href="#transactions-management" title="Permalink to this headline">¶</a></h1>
<p>Psycopg has a behaviour that may seem surprising compared to
<strong class="program">psql</strong>: by default, any database operation will start a new
transaction. As a consequence, changes made by any cursor of the connection
will not be visible until <a class="reference internal" href="../api/connections.html#psycopg.Connection.commit" title="psycopg.Connection.commit"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Connection.commit()</span></code></a> is called, and will be
discarded by <a class="reference internal" href="../api/connections.html#psycopg.Connection.rollback" title="psycopg.Connection.rollback"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Connection.rollback()</span></code></a>. The following operation on the same
connection will start a new transaction.</p>
<p>If a database operation fails, the server will refuse further commands, until
a <code class="xref py py-obj docutils literal notranslate"><span class="pre">rollback()</span></code> is called.</p>
<p>If the cursor is closed with a transaction open, no COMMIT command is sent to
the server, which will then discard the connection. Certain middleware (such
as PgBouncer) will also discard a connection left in transaction state, so, if
possible you will want to commit or rollback a connection before finishing
working with it.</p>
<p>An example of what will happen, the first time you will use Psycopg (and to be
disappointed by it), is likely:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

<span class="c1"># Creating a cursor doesn't start a transaction or affect the connection</span>
<span class="c1"># in any way.</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"SELECT count(*) FROM my_table"</span><span class="p">)</span>
<span class="c1"># This function call executes:</span>
<span class="c1"># - BEGIN</span>
<span class="c1"># - SELECT count(*) FROM my_table</span>
<span class="c1"># So now a transaction has started.</span>

<span class="c1"># If your program spends a long time in this state, the server will keep</span>
<span class="c1"># a connection "idle in transaction", which is likely something undesired</span>

<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"INSERT INTO data VALUES (</span><span class="si">%s</span><span class="s2">)"</span><span class="p">,</span> <span class="p">(</span><span class="s2">"Hello"</span><span class="p">,))</span>
<span class="c1"># This statement is executed inside the transaction</span>

<span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c1"># No COMMIT was sent: the INSERT was discarded.</span>
</pre></div>
</div>
<p>There are a few things going wrong here, let’s see how they can be improved.</p>
<p>One obvious problem after the run above is that, firing up <strong class="program">psql</strong>,
you will see no new record in the table <code class="docutils literal notranslate"><span class="pre">data</span></code>. One way to fix the problem
is to call <code class="xref py py-obj docutils literal notranslate"><span class="pre">conn.commit()</span></code> before closing the connection. Thankfully, if you
use the <a class="reference internal" href="usage.html#with-connection"><span class="std std-ref">connection context</span></a>, Psycopg will commit the
connection at the end of the block (or roll it back if the block is exited
with an exception):</p>
<p>The code modified using a connection context will result in the following
sequence of database statements:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="k">with</span> <span class="n">psycopg</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"SELECT count(*) FROM my_table"</span><span class="p">)</span>
    <span class="c1"># This function call executes:</span>
    <span class="c1"># - BEGIN</span>
    <span class="c1"># - SELECT count(*) FROM my_table</span>
    <span class="c1"># So now a transaction has started.</span>

    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"INSERT INTO data VALUES (</span><span class="si">%s</span><span class="s2">)"</span><span class="p">,</span> <span class="p">(</span><span class="s2">"Hello"</span><span class="p">,))</span>
    <span class="c1"># This statement is executed inside the transaction</span>

<span class="c1"># No exception at the end of the block:</span>
<span class="c1"># COMMIT is executed.</span>
</pre></div>
</div>
<p>This way we don’t have to remember to call neither <code class="xref py py-obj docutils literal notranslate"><span class="pre">close()</span></code> nor <code class="xref py py-obj docutils literal notranslate"><span class="pre">commit()</span></code>
and the database operations actually have a persistent effect. The code might
still do something you don’t expect: keep a transaction from the first
operation to the connection closure. You can have a finer control over the
transactions using an <a class="reference internal" href="#autocommit"><span class="std std-ref">autocommit transaction</span></a> and/or
<a class="reference internal" href="#transaction-context"><span class="std std-ref">transaction contexts</span></a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>By default even a simple <code class="sql docutils literal notranslate"><span class="pre">SELECT</span></code> will start a transaction: in
long-running programs, if no further action is taken, the session will
remain <em>idle in transaction</em>, an undesirable condition for several
reasons (locks are held by the session, tables bloat…). For long lived
scripts, either make sure to terminate a transaction as soon as possible or
use an <a class="reference internal" href="../api/connections.html#psycopg.Connection.autocommit" title="psycopg.Connection.autocommit"><code class="xref py py-obj docutils literal notranslate"><span class="pre">autocommit</span></code></a> connection.</p>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>If a database operation fails with an error message such as
<em>InFailedSqlTransaction: current transaction is aborted, commands ignored
until end of transaction block</em>, it means that <strong>a previous operation
failed</strong> and the database session is in a state of error. You need to call
<a class="reference internal" href="../api/connections.html#psycopg.Connection.rollback" title="psycopg.Connection.rollback"><code class="xref py py-obj docutils literal notranslate"><span class="pre">rollback()</span></code></a> if you want to keep on using the same connection.</p>
</div>
<section id="autocommit-transactions">
<span id="autocommit"></span><h2>Autocommit transactions<a class="headerlink" href="#autocommit-transactions" title="Permalink to this headline">¶</a></h2>
<p>The manual commit requirement can be suspended using <a class="reference internal" href="../api/connections.html#psycopg.Connection.autocommit" title="psycopg.Connection.autocommit"><code class="xref py py-obj docutils literal notranslate"><span class="pre">autocommit</span></code></a>,
either as connection attribute or as <a class="reference internal" href="../api/connections.html#psycopg.Connection.connect" title="psycopg.Connection.connect"><code class="xref py py-obj docutils literal notranslate"><span class="pre">connect()</span></code></a>
parameter. This may be required to run operations that cannot be executed
inside a transaction, such as <code class="sql docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">DATABASE</span></code>, <code class="sql docutils literal notranslate"><span class="pre">VACUUM</span></code>,
<code class="sql docutils literal notranslate"><span class="pre">CALL</span></code> on <a class="reference external" href="https://www.postgresql.org/docs/current/xproc.html">stored procedures</a> using transaction control.</p>
<p>With an autocommit transaction, the above sequence of operation results in:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="k">with</span> <span class="n">psycopg</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"SELECT count(*) FROM my_table"</span><span class="p">)</span>
    <span class="c1"># This function call now only executes:</span>
    <span class="c1"># - SELECT count(*) FROM my_table</span>
    <span class="c1"># and no transaction starts.</span>

    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"INSERT INTO data VALUES (</span><span class="si">%s</span><span class="s2">)"</span><span class="p">,</span> <span class="p">(</span><span class="s2">"Hello"</span><span class="p">,))</span>
    <span class="c1"># The result of this statement is persisted immediately by the database</span>

<span class="c1"># The connection is closed at the end of the block but, because it is not</span>
<span class="c1"># in a transaction state, no COMMIT is executed.</span>
</pre></div>
</div>
<p>An autocommit transaction behaves more as someone coming from <strong class="program">psql</strong>
would expect. This has a beneficial performance effect, because less queries
are sent and less operations are performed by the database. The statements,
however, are not executed in an atomic transaction; if you need to execute
certain operations inside a transaction, you can achieve that with an
autocommit connection too, using an explicit <a class="reference internal" href="#transaction-context"><span class="std std-ref">transaction block</span></a>.</p>
</section>
<section id="transaction-contexts">
<span id="transaction-context"></span><h2>Transaction contexts<a class="headerlink" href="#transaction-contexts" title="Permalink to this headline">¶</a></h2>
<p>A more transparent way to make sure that transactions are finalised at the
right time is to use <code class="docutils literal notranslate"><span class="pre">with</span></code> <a class="reference internal" href="../api/connections.html#psycopg.Connection.transaction" title="psycopg.Connection.transaction"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Connection.transaction()</span></code></a> to create a
transaction context. When the context is entered, a transaction is started;
when leaving the context the transaction is committed, or it is rolled back if
an exception is raised inside the block.</p>
<p>Continuing the example above, if you want to use an autocommit connection but
still wrap selected groups of commands inside an atomic transaction, you can
use a <code class="xref py py-obj docutils literal notranslate"><span class="pre">transaction()</span></code> context:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">psycopg</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>

    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"SELECT count(*) FROM my_table"</span><span class="p">)</span>
    <span class="c1"># The connection is autocommit, so no BEGIN executed.</span>

<span class="hll">    <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
</span>        <span class="c1"># BEGIN is executed, a transaction started</span>

        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"INSERT INTO data VALUES (</span><span class="si">%s</span><span class="s2">)"</span><span class="p">,</span> <span class="p">(</span><span class="s2">"Hello"</span><span class="p">,))</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"INSERT INTO times VALUES (now())"</span><span class="p">)</span>
        <span class="c1"># These two operation run atomically in the same transaction</span>

    <span class="c1"># COMMIT is executed at the end of the block.</span>
    <span class="c1"># The connection is in idle state again.</span>

<span class="c1"># The connection is closed at the end of the block.</span>
</pre></div>
</div>
<p>Note that connection blocks can also be used with non-autocommit connections:
in this case you still need to pay attention to eventual transactions started
automatically. If an operation starts an implicit transaction, a
<code class="xref py py-obj docutils literal notranslate"><span class="pre">transaction()</span></code> block will only manage <a class="reference internal" href="#nested-transactions"><span class="std std-ref">a savepoint sub-transaction</span></a>, leaving the caller to deal with the main transaction,
as explained in <a class="reference internal" href="#transactions"><span class="std std-ref">Transactions management</span></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"SELECT count(*) FROM my_table"</span><span class="p">)</span>
<span class="c1"># This function call executes:</span>
<span class="c1"># - BEGIN</span>
<span class="c1"># - SELECT count(*) FROM my_table</span>
<span class="c1"># So now a transaction has started.</span>

<span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
    <span class="c1"># The block starts with a transaction already open, so it will execute</span>
    <span class="c1"># - SAVEPOINT</span>

    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">"INSERT INTO data VALUES (</span><span class="si">%s</span><span class="s2">)"</span><span class="p">,</span> <span class="p">(</span><span class="s2">"Hello"</span><span class="p">,))</span>

<span class="c1"># The block was executing a sub-transaction so on exit it will only run:</span>
<span class="c1"># - RELEASE SAVEPOINT</span>
<span class="c1"># The transaction is still on.</span>

<span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c1"># No COMMIT was sent: the INSERT was discarded.</span>
</pre></div>
</div>
<p>If a <code class="xref py py-obj docutils literal notranslate"><span class="pre">transaction()</span></code> block starts when no transaction is active then it will
manage a proper transaction. In essence, a transaction context tries to leave
a connection in the state it found it, and leaves you to deal with the wider
context.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>The interaction between non-autocommit transactions and transaction
contexts is probably surprising. Although the non-autocommit default is
what’s demanded by the DBAPI, the personal preference of several experienced
developers is to:</p>
<ul class="simple">
<li><p>use a connection block: <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">psycopg.connect(...)</span> <span class="pre">as</span> <span class="pre">conn</span></code>;</p></li>
<li><p>use an autocommit connection, either passing <code class="docutils literal notranslate"><span class="pre">autocommit=True</span></code> as
<code class="xref py py-obj docutils literal notranslate"><span class="pre">connect()</span></code> parameter or setting the attribute <code class="docutils literal notranslate"><span class="pre">conn.autocommit</span> <span class="pre">=</span>
<span class="pre">True</span></code>;</p></li>
<li><p>use <code class="xref py py-obj docutils literal notranslate"><span class="pre">with</span> <span class="pre">conn.transaction()</span></code> blocks to manage transactions only where
needed.</p></li>
</ul>
</div>
<section id="nested-transactions">
<span id="id2"></span><h3>Nested transactions<a class="headerlink" href="#nested-transactions" title="Permalink to this headline">¶</a></h3>
<p>Transaction blocks can be also nested (internal transaction blocks are
implemented using <a class="reference external" href="https://www.postgresql.org/docs/current/sql-savepoint.html">SAVEPOINT</a>): an exception raised inside an inner block
has a chance of being handled and not completely fail outer operations. The
following is an example where a series of operations interact with the
database: operations are allowed to fail; at the end we also want to store the
number of operations successfully processed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">tx1</span><span class="p">:</span>
    <span class="n">num_ok</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">operation</span> <span class="ow">in</span> <span class="n">operations</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">tx2</span><span class="p">:</span>
                <span class="n">unreliable_operation</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">operation</span><span class="si">}</span><span class="s2"> failed"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_ok</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">save_number_of_successes</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">num_ok</span><span class="p">)</span>
</pre></div>
</div>
<p>If <code class="xref py py-obj docutils literal notranslate"><span class="pre">unreliable_operation()</span></code> causes an error, including an operation causing a
database error, all its changes will be reverted. The exception bubbles up
outside the block: in the example it is intercepted by the <code class="docutils literal notranslate"><span class="pre">try</span></code> so that the
loop can complete. The outermost block is unaffected (unless other errors
happen there).</p>
<p>You can also write code to explicitly roll back any currently active
transaction block, by raising the <a class="reference internal" href="../api/connections.html#psycopg.Rollback" title="psycopg.Rollback"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Rollback</span></code></a> exception. The exception “jumps”
to the end of a transaction block, rolling back its transaction but allowing
the program execution to continue from there. By default the exception rolls
back the innermost transaction block, but any current block can be specified
as the target. In the following example, a hypothetical <code class="xref py py-obj docutils literal notranslate"><span class="pre">CancelCommand</span></code>
may stop the processing and cancel any operation previously performed,
but not entirely committed yet.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">psycopg</span> <span class="kn">import</span> <span class="n">Rollback</span>

<span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">outer_tx</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">inner_tx</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">CancelCommand</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">Rollback</span><span class="p">(</span><span class="n">outer_tx</span><span class="p">)</span>
            <span class="n">process_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

<span class="c1"># If `Rollback` is raised, it would propagate only up to this block,</span>
<span class="c1"># and the program would continue from here with no exception.</span>
</pre></div>
</div>
</section>
</section>
<section id="transaction-characteristics">
<span id="id4"></span><h2>Transaction characteristics<a class="headerlink" href="#transaction-characteristics" title="Permalink to this headline">¶</a></h2>
<p>You can set <a class="reference external" href="https://www.postgresql.org/docs/current/sql-set-transaction.html">transaction parameters</a> for the transactions that Psycopg
handles. They affect the transactions started implicitly by non-autocommit
transactions and the ones started explicitly by <a class="reference internal" href="../api/connections.html#psycopg.Connection.transaction" title="psycopg.Connection.transaction"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Connection.transaction()</span></code></a> for
both autocommit and non-autocommit transactions. Leaving these parameters as
<code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code> will use the server’s default behaviour (which is controlled
by server settings such as <a class="reference external" href="https://www.postgresql.org/docs/current/runtime-config-client.html#GUC-DEFAULT-TRANSACTION-ISOLATION">default_transaction_isolation</a>).</p>
<p>In order to set these parameters you can use the connection attributes
<a class="reference internal" href="../api/connections.html#psycopg.Connection.isolation_level" title="psycopg.Connection.isolation_level"><code class="xref py py-obj docutils literal notranslate"><span class="pre">isolation_level</span></code></a>, <a class="reference internal" href="../api/connections.html#psycopg.Connection.read_only" title="psycopg.Connection.read_only"><code class="xref py py-obj docutils literal notranslate"><span class="pre">read_only</span></code></a>,
<a class="reference internal" href="../api/connections.html#psycopg.Connection.deferrable" title="psycopg.Connection.deferrable"><code class="xref py py-obj docutils literal notranslate"><span class="pre">deferrable</span></code></a>. For async connections you must use the equivalent
<a class="reference internal" href="../api/connections.html#psycopg.AsyncConnection.set_isolation_level" title="psycopg.AsyncConnection.set_isolation_level"><code class="xref py py-obj docutils literal notranslate"><span class="pre">set_isolation_level()</span></code></a> method and similar. The parameters
can only be changed if there isn’t a transaction already active on the
connection.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Applications running at <a class="reference internal" href="../api/connections.html#psycopg.IsolationLevel.REPEATABLE_READ" title="psycopg.IsolationLevel.REPEATABLE_READ"><code class="xref py py-obj docutils literal notranslate"><span class="pre">REPEATABLE_READ</span></code></a> or
<a class="reference internal" href="../api/connections.html#psycopg.IsolationLevel.SERIALIZABLE" title="psycopg.IsolationLevel.SERIALIZABLE"><code class="xref py py-obj docutils literal notranslate"><span class="pre">SERIALIZABLE</span></code></a> isolation level are exposed to serialization
failures. <a class="reference external" href="https://www.postgresql.org/docs/current/transaction-iso.html#XACT-REPEATABLE-READ">In certain concurrent update cases</a>, PostgreSQL will raise an
exception looking like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">psycopg2</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">SerializationFailure</span><span class="p">:</span> <span class="n">could</span> <span class="ow">not</span> <span class="n">serialize</span> <span class="n">access</span>
<span class="n">due</span> <span class="n">to</span> <span class="n">concurrent</span> <span class="n">update</span>
</pre></div>
</div>
<p>In this case the application must be prepared to repeat the operation that
caused the exception.</p>
</div>
</section>
<section id="two-phase-commit-protocol-support">
<span id="two-phase-commit"></span><span id="index-3"></span><h2>Two-Phase Commit protocol support<a class="headerlink" href="#two-phase-commit-protocol-support" title="Permalink to this headline">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified added">New in version 3.1.</span></p>
</div>
<p>Psycopg exposes the two-phase commit features available in PostgreSQL
implementing the <a class="reference external" href="https://www.python.org/dev/peps/pep-0249/#optional-two-phase-commit-extensions">two-phase commit extensions</a> proposed by the DBAPI.</p>
<p>The DBAPI model of two-phase commit is inspired by the <a class="reference external" href="https://publications.opengroup.org/c193">XA specification</a>,
according to which transaction IDs are formed from three components:</p>
<ul class="simple">
<li><p>a format ID (non-negative 32 bit integer)</p></li>
<li><p>a global transaction ID (string not longer than 64 bytes)</p></li>
<li><p>a branch qualifier (string not longer than 64 bytes)</p></li>
</ul>
<p>For a particular global transaction, the first two components will be the same
for all the resources. Every resource will be assigned a different branch
qualifier.</p>
<p>According to the DBAPI specification, a transaction ID is created using the
<a class="reference internal" href="../api/connections.html#psycopg.Connection.xid" title="psycopg.Connection.xid"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Connection.xid()</span></code></a> method. Once you have a transaction id, a distributed
transaction can be started with <a class="reference internal" href="../api/connections.html#psycopg.Connection.tpc_begin" title="psycopg.Connection.tpc_begin"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Connection.tpc_begin()</span></code></a>, prepared using
<a class="reference internal" href="../api/connections.html#psycopg.Connection.tpc_prepare" title="psycopg.Connection.tpc_prepare"><code class="xref py py-obj docutils literal notranslate"><span class="pre">tpc_prepare()</span></code></a> and completed using <a class="reference internal" href="../api/connections.html#psycopg.Connection.tpc_commit" title="psycopg.Connection.tpc_commit"><code class="xref py py-obj docutils literal notranslate"><span class="pre">tpc_commit()</span></code></a> or
<a class="reference internal" href="../api/connections.html#psycopg.Connection.tpc_rollback" title="psycopg.Connection.tpc_rollback"><code class="xref py py-obj docutils literal notranslate"><span class="pre">tpc_rollback()</span></code></a>.  Transaction IDs can also be retrieved from the
database using <a class="reference internal" href="../api/connections.html#psycopg.Connection.tpc_recover" title="psycopg.Connection.tpc_recover"><code class="xref py py-obj docutils literal notranslate"><span class="pre">tpc_recover()</span></code></a> and completed using the above
<code class="xref py py-obj docutils literal notranslate"><span class="pre">tpc_commit()</span></code> and <code class="xref py py-obj docutils literal notranslate"><span class="pre">tpc_rollback()</span></code>.</p>
<p>PostgreSQL doesn’t follow the XA standard though, and the ID for a PostgreSQL
prepared transaction can be any string up to 200 characters long. Psycopg’s
<a class="reference internal" href="../api/connections.html#psycopg.Xid" title="psycopg.Xid"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Xid</span></code></a> objects can represent both XA-style transactions IDs (such as the ones
created by the <code class="xref py py-obj docutils literal notranslate"><span class="pre">xid()</span></code> method) and PostgreSQL transaction IDs identified by
an unparsed string.</p>
<p>The format in which the Xids are converted into strings passed to the
database is the same employed by the <a class="reference external" href="https://jdbc.postgresql.org/">PostgreSQL JDBC driver</a>: this should
allow interoperation between tools written in Python and in Java. For example
a recovery tool written in Python would be able to recognize the components of
transactions produced by a Java program.</p>
<p>For further details see the documentation for the <a class="reference internal" href="../api/connections.html#tpc-methods"><span class="std std-ref">Two-Phase Commit support methods</span></a>.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="copy.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Using COPY TO and COPY FROM</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="pgtypes.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Adapting other PostgreSQL types</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2020, Daniele Varrazzo and The Psycopg Team |
          Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Transactions management</a><ul>
<li><a class="reference internal" href="#autocommit-transactions">Autocommit transactions</a></li>
<li><a class="reference internal" href="#transaction-contexts">Transaction contexts</a><ul>
<li><a class="reference internal" href="#nested-transactions">Nested transactions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#transaction-characteristics">Transaction characteristics</a></li>
<li><a class="reference internal" href="#two-phase-commit-protocol-support">Two-Phase Commit protocol support</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    </body>
</html>